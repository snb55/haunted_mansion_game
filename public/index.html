<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haunted Mansion - Interactive Adventure</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Welcome Screen */
        .welcome-box {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #8b0000;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 0 40px rgba(139, 0, 0, 0.6);
        }

        .welcome-box h1 {
            font-size: 2.5em;
            color: #ff4444;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.8);
            margin-bottom: 20px;
            letter-spacing: 5px;
        }

        .banner-text {
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-left: 5px solid #8b0000;
            margin: 30px 0;
            text-align: left;
            white-space: pre-line;
            line-height: 1.8;
        }

        .button {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #8b0000, #a50000);
            color: #fff;
            border: 2px solid #ff0000;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
        }

        .button:hover {
            background: linear-gradient(135deg, #a50000, #c00000);
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.6);
            transform: translateY(-3px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-secondary {
            background: linear-gradient(135deg, #333, #555);
            border-color: #666;
        }

        .button-secondary:hover {
            background: linear-gradient(135deg, #555, #777);
            box-shadow: 0 0 20px rgba(100, 100, 100, 0.6);
        }

        /* Game Screen */
        .game-screen {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #8b0000;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 40px rgba(139, 0, 0, 0.6);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #8b0000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .game-header h2 {
            color: #ff4444;
            font-size: 2em;
            text-shadow: 0 0 15px rgba(255, 68, 68, 0.8);
            letter-spacing: 3px;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .game-header-left, .game-header-right {
            min-width: 120px;
        }

        .game-header-right {
            text-align: right;
        }

        .sound-toggle-btn {
            background: rgba(139, 0, 0, 0.6);
            border: 2px solid #8b0000;
            color: #ff9900;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .sound-toggle-btn:hover {
            background: rgba(180, 0, 0, 0.8);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        }

        .game-id-display {
            color: #888;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }

        .game-id-display span {
            color: #ff9900;
            font-weight: bold;
        }

        .ascii-art {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            white-space: pre;
            font-size: 0.9em;
            color: #aaa;
            overflow-x: auto;
            text-align: center;
        }

        .room-image {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #8b0000;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            max-height: 35vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .room-image img, .room-image video {
            max-width: 100%;
            max-height: 32vh;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
            display: block;
            object-fit: contain;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .room-image img.fade-out, .room-image video.fade-out {
            opacity: 0;
        }

        /* Smooth crossfade for images */
        #room-image {
            transition: opacity 0.8s ease-in-out;
        }

        #room-video {
            transition: opacity 0.8s ease-in-out;
        }

        .location-desc {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            white-space: pre-line;
            line-height: 1.4;
            max-height: 20vh;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .divider {
            border-top: 2px solid #8b0000;
            margin: 10px 0;
        }

        .command-menu {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #444;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 25vh;
            overflow-y: auto;
        }

        .command-item {
            padding: 8px 15px;
            margin: 3px 0;
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid #555;
            border-radius: 5px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .command-item .icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .command-item:hover {
            background: rgba(50, 50, 50, 0.9);
            border-color: #777;
            color: #fff;
        }

        .command-item.selected {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(180, 0, 0, 0.9));
            border: 3px solid #ff0000;
            color: #fff;
            transform: translateX(15px);
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.7);
            font-weight: bold;
        }

        /* Exit Mansion Button - Golden Glowing */
        .command-item.exit-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 4px solid #FFD700;
            color: #000;
            font-weight: bold;
            font-size: 1.3em;
            padding: 20px;
            animation: goldPulse 2s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
        }

        .command-item.exit-button.selected {
            background: linear-gradient(135deg, #FFA500, #FFD700);
            border: 4px solid #FFA500;
            transform: translateX(20px) scale(1.05);
            box-shadow: 0 0 60px rgba(255, 215, 0, 1);
        }

        @keyframes goldPulse {
            0%, 100% {
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            }
            50% {
                box-shadow: 0 0 60px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 165, 0, 0.6);
            }
        }

        .menu-hint {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            padding: 15px;
            font-style: italic;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
        }

        /* Message display for action results */
        .message-display {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #444;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-line;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .message-display.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        /* Chat history styles */
        .chat-history {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #444;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
        }

        .chat-message.player {
            background: rgba(0, 100, 200, 0.3);
            border-left: 3px solid #0099ff;
            text-align: right;
        }

        .chat-message.npc {
            background: rgba(139, 0, 0, 0.3);
            border-left: 3px solid #ff4444;
        }

        .chat-message .sender {
            font-weight: bold;
            color: #ff9900;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .chat-message .text {
            color: #e0e0e0;
            line-height: 1.5;
        }

        .chat-message.player .sender {
            color: #0099ff;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .continue-hint {
            text-align: center;
            color: #ff9900;
            font-size: 0.95em;
            margin-top: 10px;
            font-style: italic;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Win screen styles */
        .win-message {
            background: rgba(0, 100, 0, 0.3);
            border: 3px solid #00ff00;
            color: #00ff00;
            font-weight: bold;
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
        }

        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            color: #ff9900;
            font-style: italic;
            margin: 10px 0;
        }

        .loading.show {
            display: block;
        }

        /* Answer input styling */
        .answer-input-container {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff9900;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: 2px solid #666;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .answer-input:focus {
            outline: none;
            border-color: #ff9900;
            box-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #8b0000;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a50000;
        }

        /* Custom Popup Styling */
        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .custom-popup-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 3px solid #ff9900;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 0 40px rgba(255, 153, 0, 0.5), 0 0 80px rgba(255, 0, 0, 0.3);
            animation: popupSlideIn 0.4s ease;
        }

        .popup-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: floatGhost 2s ease-in-out infinite;
        }

        .popup-message {
            color: #fff;
            font-size: 1.3em;
            line-height: 1.6;
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
            white-space: pre-line;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .popup-btn {
            padding: 12px 30px;
            font-size: 1.1em;
            border: 2px solid #ff9900;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .popup-btn-primary {
            background: #ff9900;
            color: #000;
        }

        .popup-btn-primary:hover {
            background: #ffaa33;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.8);
            transform: scale(1.05);
        }

        .popup-btn-secondary {
            background: transparent;
            color: #ff9900;
        }

        .popup-btn-secondary:hover {
            background: rgba(255, 153, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.5);
            transform: scale(1.05);
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes floatGhost {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Multiplayer Chat Styles */
        #multiplayer-chat {
            margin-top: 20px;
            border-top: 2px solid #8b0000;
            padding-top: 15px;
        }

        .chat-container {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #8b0000;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            background: rgba(139, 0, 0, 0.8);
            color: #ff9900;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 0.9em;
            border-bottom: 1px solid #8b0000;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message.own {
            background: rgba(0, 100, 200, 0.3);
            border-left: 3px solid #0066cc;
            align-self: flex-end;
            max-width: 80%;
        }

        .chat-message.other {
            background: rgba(139, 0, 0, 0.3);
            border-left: 3px solid #ff9900;
            align-self: flex-start;
            max-width: 80%;
        }

        .chat-sender {
            font-weight: bold;
            color: #ff9900;
            font-size: 0.85em;
            margin-bottom: 2px;
        }

        .chat-text {
            color: #e0e0e0;
        }

        .chat-input-container {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 1px solid #444;
        }

        .chat-input {
            flex: 1;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .chat-input:focus {
            outline: none;
            border-color: #ff9900;
        }

        .chat-send-btn {
            background: rgba(139, 0, 0, 0.8);
            border: 2px solid #8b0000;
            color: #ff9900;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: rgba(180, 0, 0, 0.9);
            border-color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-box">
                <h1>üèöÔ∏è HAUNTED MANSION üèöÔ∏è</h1>
                <img src="/images/entrance_hall/outside_of_mansion_intro.png" alt="Haunted Mansion" style="width: 100%; max-width: 700px; border-radius: 10px; margin: 20px 0; box-shadow: 0 0 40px rgba(139, 0, 0, 0.9);">
                <div style="color: #ccc; font-size: 1.1em; line-height: 1.8; margin: 20px auto; max-width: 600px; text-align: center;">
                    <p style="margin-bottom: 15px;">You stand before a decrepit mansion on a foggy hillside.</p>
                    <p style="margin-bottom: 15px;">The windows are dark, and strange sounds echo from within.</p>
                    <p style="color: #ff9900; font-weight: bold;">Your goal: ESCAPE the mansion before it's too late!</p>
                </div>
                <div style="margin: 20px 0;">
                    <button id="enable-sound-btn" class="button" onclick="enableSound()" style="background: linear-gradient(135deg, #ff8800, #ff6600); border-color: #ff9900;">
                        üîä Enable Sound & Music
                    </button>
                </div>
                <div>
                    <button class="button" onclick="checkForSave()">üéÆ Solo Adventure</button>
                    <button class="button" onclick="showMultiplayerMenu()">üë• Multiplayer</button>
                </div>
            </div>
        </div>

        <!-- Multiplayer Menu Screen -->
        <div id="multiplayer-screen" class="screen">
            <div class="welcome-box">
                <h1>üë• MULTIPLAYER</h1>
                <div class="banner-text" style="text-align: center; padding: 40px;">
Choose your adventure mode:

Create a new room to play with friends
or join an existing room with a code.
                </div>
                <div>
                    <button class="button" onclick="createRoom()">üÜï Create Room</button>
                    <button class="button" onclick="showJoinRoom()">üîë Join Room</button>
                    <button class="button button-secondary" onclick="showScreen('welcome-screen')">‚¨ÖÔ∏è Back</button>
                </div>
            </div>
        </div>

        <!-- Join Room Screen -->
        <div id="join-room-screen" class="screen">
            <div class="welcome-box">
                <h1>üîë JOIN ROOM</h1>
                <div class="banner-text" style="text-align: center; padding: 30px;">
Enter the 6-character room code:
                </div>
                <div style="margin: 20px 0;">
                    <input type="text" id="room-code-input" class="answer-input" placeholder="ABC123" maxlength="6" style="text-transform: uppercase; text-align: center; font-size: 1.5em;">
                </div>
                <div>
                    <button class="button" onclick="joinRoom()">‚úì Join</button>
                    <button class="button button-secondary" onclick="showScreen('multiplayer-screen')">‚¨ÖÔ∏è Back</button>
                </div>
            </div>
        </div>

        <!-- Continue Screen -->
        <div id="continue-screen" class="screen">
            <div class="welcome-box">
                <h1>üèöÔ∏è HAUNTED MANSION üèöÔ∏è</h1>
                <div class="banner-text" style="text-align: center; padding: 40px;">
üïØÔ∏è A saved game has been found.

Would you like to continue your previous game?
                </div>
                <div>
                    <button class="button" onclick="loadGame()">‚úì Yes, Continue</button>
                    <button class="button button-secondary" onclick="startNewGame()">‚úó No, Start New Game</button>
                </div>
            </div>
        </div>

        <!-- Custom Popup Modal -->
        <div id="custom-popup" class="custom-popup-overlay" style="display:none;">
            <div class="custom-popup-box">
                <div class="popup-icon">üëª</div>
                <div class="popup-message" id="popup-message">Message here</div>
                <div class="popup-buttons" id="popup-buttons">
                    <button class="popup-btn popup-btn-primary" onclick="closePopup(true)">OK</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-screen">
                <div class="game-header">
                    <div class="game-header-left">
                        <button id="sound-toggle" class="sound-toggle-btn" onclick="toggleSound()" title="Sound Off (click to unmute)">
                            üîá
                        </button>
                    </div>
                    <h2>üïØÔ∏è HAUNTED MANSION üïØÔ∏è</h2>
                    <div class="game-header-right">
                        <div class="game-id-display" id="room-code-display" style="display:none;">
                            Room: <span id="game-id-display" style="color:#ff0000; font-size:1.2em; font-weight:bold;">---</span>
                        </div>
                        <button id="save-quit-btn" class="sound-toggle-btn" onclick="saveAndQuit()" title="Save & Quit" style="margin-left:10px;">
                            üíæ Quit
                        </button>
                    </div>
                </div>

                <div id="room-image-container" class="room-image">
                    <video id="room-video" style="display:none;" playsinline muted></video>
                    <img id="room-image" src="" alt="Room" style="opacity:1;">
                </div>

                <div class="divider"></div>

                <div id="location-desc" class="location-desc"></div>

                <div class="divider"></div>

                <div id="message-display" class="message-display"></div>

                <div id="chat-history" class="chat-history" style="display:none;">
                    <!-- Chat messages will stack here -->
                </div>

                <div id="command-menu" class="command-menu">
                    <!-- Commands will be populated here -->
                </div>

                <div id="answer-input-container" class="answer-input-container" style="display:none;">
                    <label for="answer-input" style="color: #ff9900; margin-bottom: 10px; display: block; font-size: 1.1em;">
                        üí¨ Chatting with NPC:
                    </label>
                    <input type="text" id="answer-input" class="answer-input" placeholder="Type your message..." autocomplete="off">
                    <div style="margin-top: 10px;">
                        <button class="button" onclick="submitAnswer()" style="padding: 10px 20px; margin-right: 10px; font-size: 1em;">üì§ Send</button>
                        <button class="button button-secondary" onclick="cancelAnswer()" style="padding: 10px 20px; font-size: 1em;">üö™ End Chat</button>
                    </div>
                    <div style="margin-top: 10px; color: #888; font-size: 0.9em; text-align: center; font-style: italic;">
                        Tap Send to send ‚Ä¢ Type "bye" to end conversation
                    </div>
                </div>

                <div class="menu-hint">
                    ‚å®Ô∏è Use ‚Üë‚Üì arrow keys to navigate or tap/click to choose
                </div>

                <div id="loading" class="loading">‚è≥ Processing...</div>

                <!-- Multiplayer Chat -->
                <div id="multiplayer-chat" style="display:none;">
                    <div class="chat-container">
                        <div class="chat-header">üí¨ Player Chat</div>
                        <div id="chat-messages" class="chat-messages"></div>
                        <div class="chat-input-container">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." maxlength="200">
                            <button onclick="sendChatMessage()" class="chat-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7fQBSKSEQ5uL4rOC_jTfPfH5Gtkpko58",
            authDomain: "gen-lang-client-0201440588.firebaseapp.com",
            projectId: "gen-lang-client-0201440588",
            storageBucket: "gen-lang-client-0201440588.firebasestorage.app",
            messagingSenderId: "1022196301835",
            appId: "1:1022196301835:web:08e064f0e4f929e2d9c70e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Game State Variables
        let selectedIndex = 0;
        let availableActions = [];
        let isWaitingForInput = false;
        let gameWon = false;
        let inChatMode = false;
        let currentNPC = null;
        let currentUserId = null;
        let currentRoomCode = null;
        let isRoomOwner = false;

        // Sound System
        const roomsVisited = new Set();
        let currentMusic = null;
        let soundEnabled = false;

        function enableSound() {
            soundEnabled = true;
            playMusic('/sounds/main_menu_ghost_piano.mp3', true);

            // Hide the enable sound button
            const btn = document.getElementById('enable-sound-btn');
            if (btn) {
                btn.style.display = 'none';
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-toggle');
            
            if (soundEnabled) {
                btn.textContent = 'üîä';
                btn.title = 'Sound On (click to mute)';
                // Play a confirmation sound
                playSound('/sounds/click.mp3');
            } else {
                btn.textContent = 'üîá';
                btn.title = 'Sound Off (click to unmute)';
                // Stop current music if any
                stopMusic();
            }
        }

        // Auto-refresh timer for multiplayer
        let autoRefreshInterval = null;

        function updateGameIdDisplay(roomCode) {
            const roomCodeDisplay = document.getElementById('room-code-display');
            const gameIdElement = document.getElementById('game-id-display');
            const chatContainer = document.getElementById('multiplayer-chat');
            
            if (roomCode && roomCodeDisplay && gameIdElement) {
                // Show room code for multiplayer
                gameIdElement.textContent = roomCode;
                roomCodeDisplay.style.display = 'block';
                
                // Show chat for multiplayer
                if (chatContainer) chatContainer.style.display = 'block';
                
                // Start auto-refresh for multiplayer
                startAutoRefresh();
                
                // Start listening to chat messages
                startChatListener(roomCode);
            } else if (roomCodeDisplay) {
                // Hide for single player
                roomCodeDisplay.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'none';
                
                // Stop auto-refresh
                stopAutoRefresh();
                
                // Stop chat listener
                stopChatListener();
            }
        }

        function startAutoRefresh() {
            // Don't start if already running
            if (autoRefreshInterval) return;
            
            console.log('üîÑ Starting auto-refresh every 3 seconds for multiplayer');
            
            autoRefreshInterval = setInterval(async () => {
                if (!currentRoomCode || gameWon || isWaitingForInput) return;
                
                try {
                    // Silently refresh game state
                    const response = await fetch(`${API_URL}/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': firebaseUserId
                        },
                        body: JSON.stringify({
                            command: 'look',
                            room_code: currentRoomCode
                        })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update view without showing loading or messages
                        if (data.image) {
                            updateRoomImage(data.image);
                        }
                        availableActions = data.actions || [];
                        renderCommandMenu(availableActions);
                    }
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }, 3000); // Every 3 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                console.log('üõë Stopping auto-refresh');
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Multiplayer Chat System
        let chatUnsubscribe = null;

        function startChatListener(roomCode) {
            if (!roomCode) return;
            
            console.log('üí¨ Starting chat listener for room:', roomCode);
            
            // Listen to chat messages in real-time
            const chatRef = db.collection('gameSessions').doc(roomCode).collection('chat');
            
            chatUnsubscribe = chatRef
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    const chatMessages = document.getElementById('chat-messages');
                    if (!chatMessages) return;
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const msg = change.doc.data();
                            addChatMessageToUI(msg);
                        }
                    });
                });
        }

        function stopChatListener() {
            if (chatUnsubscribe) {
                console.log('üõë Stopping chat listener');
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
        }

        function addChatMessageToUI(message) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;
            
            const isOwn = message.userId === currentUserId;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;
            msgDiv.innerHTML = `
                <div class="chat-sender">${isOwn ? 'You' : message.playerName || 'Player'}</div>
                <div class="chat-text">${escapeHtml(message.text)}</div>
            `;
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (!input || !currentRoomCode) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            
            try {
                // Get player number from room data
                const roomDoc = await db.collection('gameSessions').doc(currentRoomCode).get();
                const players = roomDoc.data()?.players || {};
                const playerName = players[firebaseUserId] || 'Player';
                
                const chatRef = db.collection('gameSessions').doc(currentRoomCode).collection('chat');
                await chatRef.add({
                    userId: currentUserId, // Tab-specific ID
                    firebaseUserId: firebaseUserId, // Firebase auth ID
                    playerName: playerName,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (soundEnabled) {
                    playSound('/sounds/click.mp3');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Allow Enter key to send chat messages
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        // Custom Popup System
        let popupResolve = null;

        function showPopup(message, options = {}) {
            return new Promise((resolve) => {
                popupResolve = resolve;
                
                const popup = document.getElementById('custom-popup');
                const messageEl = document.getElementById('popup-message');
                const buttonsEl = document.getElementById('popup-buttons');
                
                messageEl.textContent = message;
                
                // Configure buttons
                if (options.confirm) {
                    // Confirm dialog (Yes/No)
                    buttonsEl.innerHTML = `
                        <button class="popup-btn popup-btn-primary" onclick="closePopup(true)">
                            ${options.confirmText || 'Continue'}
                        </button>
                        <button class="popup-btn popup-btn-secondary" onclick="closePopup(false)">
                            ${options.cancelText || 'Exit'}
                        </button>
                    `;
                } else {
                    // Alert dialog (OK only)
                    buttonsEl.innerHTML = `
                        <button class="popup-btn popup-btn-primary" onclick="closePopup(true)">
                            ${options.okText || 'OK'}
                        </button>
                    `;
                }
                
                // Play sound
                if (soundEnabled) {
                    playSound('/static/sounds/click.mp3');
                }
                
                popup.style.display = 'flex';
            });
        }

        function closePopup(result) {
            const popup = document.getElementById('custom-popup');
            popup.style.display = 'none';
            
            if (popupResolve) {
                popupResolve(result);
                popupResolve = null;
            }
        }

        async function saveAndQuit() {
            // Stop any music/sounds
            stopMusic();
            
            // Stop auto-refresh
            stopAutoRefresh();
            
            // Stop chat listener
            stopChatListener();
            
            // If in multiplayer room, leave it
            if (currentRoomCode) {
                try {
                    await fetch(`${API_URL}/leave_room`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': firebaseUserId
                        },
                        body: JSON.stringify({ room_code: currentRoomCode })
                    });
                } catch (error) {
                    console.error('Error leaving room:', error);
                }
                currentRoomCode = null;
            } else {
                // Single player - save game to Firestore
                try {
                    await fetch(`${API_URL}/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': firebaseUserId
                        },
                        body: JSON.stringify({ command: 'look' }) // Trigger a save
                    });
                    console.log('‚úÖ Game saved to Firestore');
                } catch (error) {
                    console.error('Error saving game:', error);
                }
            }
            
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) chatMessages.innerHTML = '';
            
            // Clear game state (with null checks)
            const locationDesc = document.getElementById('location-desc');
            if (locationDesc) locationDesc.textContent = '';
            
            const menuHint = document.querySelector('.menu-hint');
            if (menuHint) menuHint.innerHTML = '';
            
            const commandList = document.getElementById('command-list');
            if (commandList) commandList.innerHTML = '';
            
            gameWon = false;
            
            // Return to welcome screen
            showScreen('welcome-screen');
            
            // Play menu music
            playMusic('/sounds/main_menu_ghost_piano.mp3', true);
        }

        function playSound(soundPath) {
            if (!soundEnabled) return;
            const audio = new Audio(soundPath);
            audio.play().catch(e => console.log('Sound play failed:', e));
        }

        function playMusic(musicPath, loop = true) {
            if (!soundEnabled) return;
            if (currentMusic) {
                currentMusic.pause();
                currentMusic = null;
            }
            currentMusic = new Audio(musicPath);
            currentMusic.loop = loop;
            currentMusic.volume = 0.3;
            currentMusic.play().catch(e => console.log('Music play failed:', e));
        }

        function stopMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic = null;
            }
        }

        // Play click sound on every button (except sound toggle)
        document.addEventListener('click', function(e) {
            if ((e.target.matches('button') || e.target.matches('.command-item')) && e.target.id !== 'sound-toggle') {
                playSound('/sounds/click.mp3');
            }
        });

        // API Configuration - Use relative path so it works with Firebase Hosting rewrites
        const API_URL = '/api';

        // Generate unique session ID for this tab
        const tabSessionId = 'tab_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        let firebaseUserId = null;

        // Initialize Firebase Auth - Sign in anonymously
        auth.onAuthStateChanged((user) => {
            if (user) {
                firebaseUserId = user.uid;
                // Use tab-specific session ID for multiplayer differentiation
                currentUserId = tabSessionId;
                console.log('‚úÖ Signed in with Firebase UID:', firebaseUserId);
                console.log('‚úÖ Tab Session ID:', currentUserId);
            } else {
                // Sign in anonymously if not signed in
                auth.signInAnonymously()
                    .then((userCredential) => {
                        firebaseUserId = userCredential.user.uid;
                        currentUserId = tabSessionId;
                        console.log('‚úÖ Anonymous sign-in successful:', firebaseUserId);
                        console.log('‚úÖ Tab Session ID:', currentUserId);
                    })
                    .catch((error) => {
                        console.error('‚ùå Auth error:', error);
                        alert('Authentication failed. Please refresh the page.');
                    });
            }
        });

        // Check for saved game on start
        async function checkForSave() {
            if (!firebaseUserId) {
                // Wait for auth
                setTimeout(checkForSave, 500);
                return;
            }

            try {
                // Check Firestore for saved game using Firebase UID
                const saveDoc = await db.collection('saves').doc(firebaseUserId).get();
                if (saveDoc.exists) {
                    const saveData = saveDoc.data();
                    // Verify the save has valid game state
                    if (saveData && saveData.gameState && saveData.gameState.player) {
                        console.log('‚úÖ Valid save found');
                        showScreen('continue-screen');
                    } else {
                        console.log('‚ö†Ô∏è Invalid save data, starting new game');
                        startNewGame();
                    }
                } else {
                    console.log('‚ÑπÔ∏è No save found, starting new game');
                    startNewGame();
                }
            } catch (error) {
                console.error('Error checking save:', error);
                startNewGame();
            }
        }

        // Start new game
        async function startNewGame() {
            if (!firebaseUserId) {
                alert('Please wait for authentication...');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/new_game`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': firebaseUserId
                    }
                });
                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    stopMusic(); // Stop menu music
                    
                    // Switch to game screen but keep it hidden initially
                    showScreen('game-screen');
                    
                    // Make sure room code is hidden for single player
                    updateGameIdDisplay(null);
                    
                    // Clear all previous game UI elements (with null checks)
                    const commandList = document.getElementById('command-list');
                    const menuHint = document.querySelector('.menu-hint');
                    if (commandList) commandList.innerHTML = '';
                    if (menuHint) menuHint.innerHTML = '';
                    
                    // Hide the room image initially to prevent flash
                    const imgElement = document.getElementById('room-image');
                    if (imgElement) {
                        imgElement.style.display = 'none';
                        imgElement.style.opacity = '0';
                    }

                    // Show "Continue... if you dare..." text WHILE video plays
                    const locationDesc = document.getElementById('location-desc');
                    if (locationDesc) locationDesc.textContent = 'Continue... if you dare...';

                    // Play intro video immediately
                    playVideo('images/videos/intro_video.mp4', () => {
                        // After video ends, show game immediately with image first
                        playRoomAmbient('entrance_hall'); // Play entrance ambient
                        
                        // Make sure we have the entrance hall image
                        if (!data.image) {
                            data.image = 'images/entrance_hall/entrance_hall_default.png';
                        }
                        
                        // Show image immediately
                        updateRoomImage(data.image);
                        
                        // Then update the rest of the game view
                        updateLocationDesc(data.message);
                        availableActions = data.actions || [];
                        renderCommandMenu(availableActions);
                        hideMessageDisplay();
                        isWaitingForInput = false;
                        gameWon = false;
                    })
                }
            } catch (error) {
                showLoading(false);
                console.error('Error starting game:', error);
                alert('Failed to start game. Please refresh and try again.');
            }
        }

        // Load saved game
        async function loadGame() {
            if (!firebaseUserId) {
                alert('Please wait for authentication...');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/load_game`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': firebaseUserId
                    }
                });
                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    stopMusic(); // Stop menu music
                    
                    // Switch to game screen first
                    showScreen('game-screen');
                    
                    // Clear all previous game UI elements (with null checks)
                    const commandList = document.getElementById('command-list');
                    const menuHint = document.querySelector('.menu-hint');
                    if (commandList) commandList.innerHTML = '';
                    if (menuHint) menuHint.innerHTML = '';
                    
                    // Hide the room image initially to prevent flash
                    const imgElement = document.getElementById('room-image');
                    if (imgElement) {
                        imgElement.style.display = 'none';
                        imgElement.style.opacity = '0';
                    }

                    // Show intro text while video plays
                    const locationDesc = document.getElementById('location-desc');
                    if (locationDesc) locationDesc.textContent = 'Welcome back...';

                    // Helper function to load game after video
                    const loadGameAfterVideo = (gameData) => {
                        console.log('Loading game after video with data:', gameData);
                        
                        // After video ends, load the saved game state
                        // Determine room for ambient sound
                        const locationDesc = gameData.location_desc || gameData.message || '';
                        let roomName = 'entrance_hall';
                        if (locationDesc.toLowerCase().includes('library')) {
                            roomName = 'library';
                        } else if (locationDesc.toLowerCase().includes('basement')) {
                            roomName = 'basement';
                        }
                        playRoomAmbient(roomName);
                        
                        // Make sure we have an image
                        if (!gameData.image) {
                            gameData.image = 'images/entrance_hall/entrance_hall_default.png';
                        }
                        
                        // Show image immediately
                        updateRoomImage(gameData.image);
                        
                        // Then update the rest of the game view
                        updateGameView(gameData);
                    };

                    // Play intro video first with timeout fallback
                    const videoTimeout = setTimeout(() => {
                        console.log('Video timeout - loading game directly');
                        loadGameAfterVideo(data);
                    }, 8000); // 8 second timeout
                    
                    playVideo('images/videos/intro_video.mp4', () => {
                        clearTimeout(videoTimeout);
                        loadGameAfterVideo(data);
                    });
                } else {
                    alert(data.message || 'Failed to load game.');
                    startNewGame();
                }
            } catch (error) {
                showLoading(false);
                console.error('Error loading game:', error);
                alert('Failed to load game. Starting new game instead.');
                startNewGame();
            }
        }

        // Execute selected command
        async function executeCommand(command) {
            if (isWaitingForInput && !gameWon) {
                // If showing result, clear it and show menu
                hideMessageDisplay();
                isWaitingForInput = false;
                return;
            }

            if (!firebaseUserId) {
                alert('Please wait for authentication...');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`${API_URL}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': firebaseUserId
                    },
                    body: JSON.stringify({
                        command: command,
                        room_code: currentRoomCode
                    })
                });
                const data = await response.json();
                showLoading(false);
                if (data.success) {
                    // Play action-specific sounds
                    const cmd = command.toLowerCase();
                    if (cmd.startsWith('go ')) {
                        playSound('/sounds/walking_between_rooms.mp3');
                        // Detect which room we're entering and play ambient
                        const desc = data.location_desc || '';
                        if (desc.includes('Library')) playRoomAmbient('library');
                        else if (desc.includes('Basement')) playRoomAmbient('basement');
                        else if (desc.includes('Entrance')) playRoomAmbient('entrance_hall');
                    } else if (cmd.startsWith('take ')) {
                        playSound('/sounds/pick_up_item.mp3');
                    } else if (cmd.startsWith('drop ')) {
                        playSound('/sounds/drop_item.mp3');
                    } else if (cmd.startsWith('use ') && cmd.includes('key')) {
                        if (data.message.includes('unlocks') || data.message.includes('open')) {
                            playSound('/sounds/unlock_and_open_door.mp3');
                        }
                    } else if (cmd.startsWith('use ') && cmd.includes('amulet')) {
                        if (data.message.includes('bookshelf') || data.message.includes('secret')) {
                            playSound('/sounds/bookshelf_opens.mp3');
                        }
                    } else if (cmd.includes('door') && (data.message.includes('locked') || data.message.includes('can\'t'))) {
                        playSound('/sounds/locked_door.mp3');
                    } else if (cmd.startsWith('examine ') && cmd.includes('door')) {
                        // Play locked door sound unless the door is unlocked
                        if (!data.message.includes('unlocked') && !data.message.includes('open')) {
                            playSound('/sounds/locked_door.mp3');
                        }
                    }

                    // Update room image
                    if (data.image) {
                        updateRoomImage(data.image);
                    }

                    // Update location description
                    if (data.location_desc) {
                        updateLocationDesc(data.location_desc);
                    }

                    // Check if this is a talk command - auto-show answer box
                    const isTalkCommand = command.toLowerCase().startsWith('talk');

                    // Show result message (with answer box if talking to NPC)
                    showMessage(data.message, data.art, isTalkCommand);

                    // Update available actions
                    availableActions = data.actions || [];

                    // Check for win
                    if (data.game_won) {
                        gameWon = true;
                        document.getElementById('answer-input-container').style.display = 'none';

                        // Play victory video
                        playVideo('images/videos/walking_out.mp4', () => {
                            // After video, show outside mansion and piano music
                            updateRoomImage('images/entrance_hall/outside_of_mansion.png');
                            playMusic('/sounds/main_menu_ghost_piano.mp3', true);

                            // Show conclusion text in the location desc
                            updateLocationDesc('You turn and look back at the decrepit mansion, still confused about how you even got here in the first place. The spirits inside were mysterious, but you were lucky they took a liking to you and helped you escape. Perhaps next time... you won\'t be so lucky.');

                            document.querySelector('.menu-hint').innerHTML = '';
                            renderCommandMenu([{
                                icon: 'üè†',
                                label: 'Return to Main Menu',
                                command: 'return_to_menu'
                            }]);
                            
                            // Victory screen - don't wait for input, just show button
                            isWaitingForInput = false;
                        });
                        return; // Don't set isWaitingForInput = true below
                    }

                    isWaitingForInput = true;
                } else {
                    alert(data.message || 'Command failed.');
                }
            } catch (error) {
                showLoading(false);
                console.error('Error executing command:', error);
                alert('Failed to execute command.');
            }
        }

        // Play video with fade in/out
        function playVideo(videoPath, onComplete) {
            const videoElement = document.getElementById('room-video');
            const imgElement = document.getElementById('room-image');

            // Fade out and hide image
            imgElement.classList.add('fade-out');

            setTimeout(() => {
                // Hide image, show video
                imgElement.style.display = 'none';
                imgElement.style.opacity = '0';
                videoElement.style.display = 'block';
                videoElement.src = '/' + videoPath;
                videoElement.classList.remove('fade-out');
                
                // Set video mute state based on sound preference
                videoElement.muted = !soundEnabled;

                // Add error handler
                videoElement.onerror = (e) => {
                    console.error('Video error:', e);
                    // Hide video and call completion callback
                    videoElement.style.display = 'none';
                    imgElement.style.display = 'block';
                    if (onComplete) onComplete();
                };

                // Play video with promise handling
                const playPromise = videoElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error('Video play failed:', error);
                        // Hide video and call completion callback
                        videoElement.style.display = 'none';
                        imgElement.style.display = 'block';
                        if (onComplete) onComplete();
                    });
                }

                // When video ends
                videoElement.onended = () => {
                    console.log('Video ended');
                    // Fade out video
                    videoElement.classList.add('fade-out');

                    setTimeout(() => {
                        videoElement.style.display = 'none';
                        videoElement.classList.remove('fade-out');
                        // Show image container again but keep it hidden until image is set
                        imgElement.style.display = 'block';
                        if (onComplete) onComplete();
                    }, 500);
                };
            }, 500);
        }

        // Update room image with smooth transitions
        function updateRoomImage(imagePath) {
            const imgElement = document.getElementById('room-image');
            const videoElement = document.getElementById('room-video');

            console.log('Updating image to:', imagePath);

            if (!imagePath) {
                imgElement.style.opacity = '0';
                imgElement.style.display = 'none';
                return;
            }

            // Hide video if showing
            videoElement.style.display = 'none';

            // Check if the image is already showing - if so, do nothing!
            const currentSrc = imgElement.src;
            const newSrc = window.location.origin + '/' + imagePath;
            
            if (currentSrc === newSrc && imgElement.style.opacity === '1') {
                console.log('Same image already showing, skipping transition');
                return;
            }

            // If changing images, use smooth crossfade
            if (imgElement.src && imgElement.src.includes('images/') && imgElement.style.opacity !== '0') {
                // Preload the new image
                const newImage = new Image();
                newImage.onload = () => {
                    // Fade out current image
                    imgElement.style.opacity = '0';
                    
                    // After fade out completes, swap and fade in
                    setTimeout(() => {
                        imgElement.src = '/' + imagePath;
                        imgElement.style.display = 'block';
                        // Small delay to ensure image is loaded
                        requestAnimationFrame(() => {
                            imgElement.style.opacity = '1';
                        });
                    }, 800); // Match transition duration
                };
                newImage.src = '/' + imagePath;
            } else {
                // First load - just show it with a gentle fade in
                imgElement.src = '/' + imagePath;
                imgElement.style.display = 'block';
                imgElement.style.opacity = '0';
                // Fade in smoothly
                requestAnimationFrame(() => {
                    imgElement.style.opacity = '1';
                });
            }
        }

        // Play room ambient sound (only first time)
        function playRoomAmbient(locationName) {
            if (roomsVisited.has(locationName)) {
                return; // Already visited
            }

            const ambientSounds = {
                'entrance_hall': '/sounds/main_entrance_creepy.mp3',
                'library': '/sounds/library_ghost_noise.mp3',
                'basement': '/sounds/basement_creepy.mp3'
            };

            if (ambientSounds[locationName]) {
                playSound(ambientSounds[locationName]);
                roomsVisited.add(locationName);
            }
        }

        // Update game view
        function updateGameView(data) {
            if (data.image) {
                updateRoomImage(data.image);
            }
            updateLocationDesc(data.message);
            availableActions = data.actions || [];
            renderCommandMenu(availableActions);
            hideMessageDisplay();
            isWaitingForInput = false;
            gameWon = false;
        }

        // Update location description
        function updateLocationDesc(desc) {
            document.getElementById('location-desc').textContent = desc || '';
        }

        // Show message (no ASCII art)
        function showMessage(message, art, showAnswerBox = false) {
            const messageDiv = document.getElementById('message-display');
            messageDiv.textContent = message;
            messageDiv.classList.add('show');
            
            // Check if this is an NPC talking (asking for an answer)
            if (showAnswerBox || message.includes('says:') || message.includes('(Type \'answer')) {
                // Auto-show answer box if NPC is asking something
                document.getElementById('command-menu').style.display = 'none';
                document.getElementById('answer-input-container').style.display = 'block';
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
                document.querySelector('.menu-hint').innerHTML =
                    'üí≠ Type your answer above and tap Submit';
            } else {
                // Normal message - hide command menu and show continue button
                document.getElementById('command-menu').style.display = 'none';
                document.querySelector('.menu-hint').innerHTML =
                    '<button class="button" onclick="hideMessageDisplay(); isWaitingForInput = false;" style="margin: 10px auto; display: block;">Continue</button>';
            }
        }

        // Hide message display
        function hideMessageDisplay() {
            const messageDiv = document.getElementById('message-display');
            messageDiv.classList.remove('show');
            document.getElementById('command-menu').style.display = 'block';
            document.getElementById('answer-input-container').style.display = 'none';
            document.querySelector('.menu-hint').innerHTML =
                '‚å®Ô∏è Use ‚Üë‚Üì arrow keys to navigate or tap/click to choose';
            renderCommandMenu(availableActions);
        }

        // Render command menu
        function renderCommandMenu(actions) {
            const menu = document.getElementById('command-menu');
            menu.innerHTML = '';
            selectedIndex = 0;

            actions.forEach((action, index) => {
                const item = document.createElement('div');
                item.className = 'command-item';
                if (index === 0) {
                    item.classList.add('selected');
                }
                
                // Add special styling for exit mansion button
                if (action.special === 'exit') {
                    item.classList.add('exit-button');
                }
                
                item.innerHTML = `
                    <span class="icon">${action.icon}</span>
                    <span>${action.label}</span>
                `;
                
                item.addEventListener('click', () => {
                    selectCommand(index);
                    executeSelectedCommand();
                });
                
                menu.appendChild(item);
            });
        }

        // Navigate commands
        function navigateUp() {
            if (availableActions.length === 0) return;
            
            const items = document.querySelectorAll('.command-item');
            items[selectedIndex].classList.remove('selected');
            
            selectedIndex = (selectedIndex - 1 + availableActions.length) % availableActions.length;
            
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }

        function navigateDown() {
            if (availableActions.length === 0) return;
            
            const items = document.querySelectorAll('.command-item');
            items[selectedIndex].classList.remove('selected');
            
            selectedIndex = (selectedIndex + 1) % availableActions.length;
            
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }

        function selectCommand(index) {
            const items = document.querySelectorAll('.command-item');
            items[selectedIndex].classList.remove('selected');
            selectedIndex = index;
            items[selectedIndex].classList.add('selected');
        }

        function executeSelectedCommand() {
            if (availableActions.length === 0) return;
            
            const action = availableActions[selectedIndex];
            if (action.command === 'new_game_special') {
                startNewGame();
            } else if (action.command === 'return_to_menu') {
                // Return to main menu after victory
                stopMusic();
                
                // Clear all game text and state (with null checks)
                const locationDesc = document.getElementById('location-desc');
                if (locationDesc) locationDesc.textContent = '';
                
                const menuHint = document.querySelector('.menu-hint');
                if (menuHint) menuHint.innerHTML = '';
                
                const commandList = document.getElementById('command-list');
                if (commandList) commandList.innerHTML = '';
                
                gameWon = false;
                
                showScreen('welcome-screen');
                playMusic('/sounds/main_menu_ghost_piano.mp3', true);
            } else if (action.command.startsWith('start_chat_')) {
                const npcId = action.command.replace('start_chat_', '');
                startChatMode(npcId);
            } else {
                executeCommand(action.command);
            }
        }
        
        function startChatMode(npcId) {
            inChatMode = true;
            currentNPC = npcId;
            
            // Hide menu and message display, show chat history and input (with null checks)
            const commandMenu = document.getElementById('command-menu');
            if (commandMenu) commandMenu.style.display = 'none';
            
            const messageDisplay = document.getElementById('message-display');
            if (messageDisplay) messageDisplay.classList.remove('show');
            
            const chatHistory = document.getElementById('chat-history');
            if (chatHistory) {
                chatHistory.style.display = 'block';
                chatHistory.innerHTML = ''; // Clear previous chat
            }
            
            const answerInputContainer = document.getElementById('answer-input-container');
            if (answerInputContainer) answerInputContainer.style.display = 'block';
            
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.value = '';
                answerInput.placeholder = 'Type your message...';
                answerInput.focus();
            }
            
            // Update label
            const label = document.querySelector('#answer-input-container label');
            if (label) label.textContent = 'üí¨ Chatting with NPC:';
            
            // Update hint
            const menuHint = document.querySelector('.menu-hint');
            if (menuHint) {
                menuHint.innerHTML = 'üí¨ Type your messages and tap Send ‚Ä¢ Type "bye" to end conversation';
            }
            
            // Add welcome message
            addChatMessage('npc', 'NPC', 'Conversation started. Say hello!');
        }
        
        function addChatMessage(type, sender, text) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <div class="text">${text}</div>
            `;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to bottom
        }

        function showAnswerPrompt() {
            // Hide command menu, show answer input
            document.getElementById('command-menu').style.display = 'none';
            document.getElementById('answer-input-container').style.display = 'block';
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            
            // Update hint
            document.querySelector('.menu-hint').innerHTML = 
                'üí≠ Type your answer and press Submit';
        }

        function cancelAnswer() {
            if (inChatMode) {
                exitChatMode();
            } else {
                // Hide answer input, show command menu
                document.getElementById('answer-input-container').style.display = 'none';
                document.getElementById('command-menu').style.display = 'block';
                document.querySelector('.menu-hint').innerHTML =
                    '‚å®Ô∏è Use ‚Üë‚Üì arrow keys to navigate or tap/click to choose';
                renderCommandMenu(availableActions);
            }
        }

        async function submitAnswer() {
            const message = document.getElementById('answer-input').value.trim();
            if (!message) {
                await showPopup('Please type a message first!');
                return;
            }
            
            // Check if ending conversation
            if (message.toLowerCase() === 'bye' || message.toLowerCase() === 'exit' || message.toLowerCase() === 'quit') {
                exitChatMode();
                return;
            }
            
            // Add player message to chat
            addChatMessage('player', 'You', message);
            
            // Clear input immediately for next message
            document.getElementById('answer-input').value = '';
            
            // Show loading
            showLoading(true);
            
            // Send message via talk command
            fetch(`${API_URL}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': firebaseUserId
                },
                body: JSON.stringify({
                    command: `talk ${message}`,
                    room_code: currentRoomCode
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);

                if (!data.success) {
                    throw new Error(data.message || 'Command failed');
                }

                // Update game state
                if (data.location_desc) {
                    updateLocationDesc(data.location_desc);
                }
                if (data.image) {
                    updateRoomImage(data.image);
                }

                // Extract NPC name and message
                const npcMatch = data.message.match(/^(.+?) says:\s*"(.+)"$/s) ||
                               data.message.match(/^(.+?) says:\s*(.+)$/s);

                if (npcMatch) {
                    const npcName = npcMatch[1].trim();
                    let npcText = npcMatch[2].trim();
                    npcText = npcText.replace(/^["']|["']$/g, ''); // Remove quotes

                    // Add NPC response to chat
                    addChatMessage('npc', npcName, npcText);

                        // Check if item was given
                        if (data.message.includes('‚ú®')) {
                            const itemMatch = data.message.match(/given you the (.+?)!/);
                            if (itemMatch) {
                                addChatMessage('npc', '‚ú® System', `${npcName} has given you the ${itemMatch[1]}!`);
                                setTimeout(async () => {
                                    const continueChat = await showPopup(
                                        `‚ú® You received the ${itemMatch[1]}! ‚ú®\n\nWould you like to continue the conversation?`,
                                        { confirm: true, confirmText: 'Continue', cancelText: 'Exit' }
                                    );
                                    if (!continueChat) {
                                        exitChatMode();
                                    }
                                }, 1500);
                            }
                        }
                } else {
                    // Fallback: show raw message
                    addChatMessage('npc', 'NPC', data.message);
                }

                // Update actions
                availableActions = data.actions || [];

                // Keep chat box focused and ready
                document.getElementById('answer-input').focus();
            })
            .catch(error => {
                showLoading(false);
                console.error('Chat error:', error);
                addChatMessage('npc', '‚ö†Ô∏è Error', 'Failed to send message. Please try again.');
                document.getElementById('answer-input').focus();
            });
        }
        
        function exitChatMode() {
            inChatMode = false;
            currentNPC = null;
            
            // Hide chat input, chat history, and message
            document.getElementById('answer-input-container').style.display = 'none';
            document.getElementById('chat-history').style.display = 'none';
            document.getElementById('message-display').classList.remove('show');
            document.getElementById('command-menu').style.display = 'block';
            
            // Reset placeholder
            document.getElementById('answer-input').placeholder = 'Enter your answer here...';
            
            // Reset label
            document.querySelector('#answer-input-container label').textContent = 'üí≠ Type your answer to the puzzle:';
            
            // Reset hint
            document.querySelector('.menu-hint').innerHTML =
                '‚å®Ô∏è Use ‚Üë‚Üì arrow keys to navigate or tap/click to choose';
            
            // Refresh command menu
            renderCommandMenu(availableActions);
            isWaitingForInput = false;
        }

        // Allow Enter key in answer input and ESC to cancel
        document.addEventListener('DOMContentLoaded', () => {
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitAnswer();
                    }
                });

                answerInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelAnswer();
                    }
                });
            }
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            const currentScreen = document.querySelector('.screen.active').id;
            
            if (currentScreen !== 'game-screen') {
                return;
            }
            
            // Don't handle arrow keys if answer input is visible
            const answerContainer = document.getElementById('answer-input-container');
            if (answerContainer && answerContainer.style.display !== 'none') {
                return;
            }
            
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (!isWaitingForInput) {
                    navigateUp();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (!isWaitingForInput) {
                    navigateDown();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Don't allow Enter on victory screen
                if (gameWon) {
                    return;
                }
                // If waiting for input (message is showing), clear it
                if (isWaitingForInput && !gameWon) {
                    hideMessageDisplay();
                    isWaitingForInput = false;
                } else if (!isWaitingForInput) {
                    // Only execute command if not waiting for input
                    executeSelectedCommand();
                }
            }
        });

        // Multiplayer Functions
        function showMultiplayerMenu() {
            showScreen('multiplayer-screen');
        }

        function showJoinRoom() {
            showScreen('join-room-screen');
            document.getElementById('room-code-input').value = '';
            document.getElementById('room-code-input').focus();
        }

        async function createRoom() {
            if (!firebaseUserId) {
                alert('Please wait for authentication...');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/create_room`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': firebaseUserId
                    }
                });
                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    currentRoomCode = data.roomCode;
                    isRoomOwner = true;
                    
                    // Update Game ID display to show room code
                    updateGameIdDisplay(data.roomCode);

                    // Start the game in multiplayer mode
                    await loadRoomGame(currentRoomCode);
                } else {
                    alert(data.message || 'Failed to create room');
                }
            } catch (error) {
                showLoading(false);
                console.error('Error creating room:', error);
                alert('Failed to create room');
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();

            if (!roomCode || roomCode.length !== 6) {
                alert('Please enter a valid 6-character room code');
                return;
            }

            if (!firebaseUserId) {
                alert('Please wait for authentication...');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/join_room`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': firebaseUserId
                    },
                    body: JSON.stringify({ room_code: roomCode })
                });
                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    currentRoomCode = roomCode;
                    isRoomOwner = false;
                    
                    // Update Game ID display to show room code
                    updateGameIdDisplay(roomCode);

                    // Load the game state from the room
                    await loadRoomGame(roomCode);
                } else {
                    alert(data.message || 'Failed to join room');
                }
            } catch (error) {
                showLoading(false);
                console.error('Error joining room:', error);
                alert('Failed to join room');
            }
        }

        async function loadRoomGame(roomCode) {
            // Load game state from room
            try {
                const docRef = db.collection('gameSessions').doc(roomCode);
                const doc = await docRef.get();

                if (!doc.exists) {
                    alert('Room not found');
                    return;
                }

                const roomData = doc.data();
                const gameState = roomData.gameState;

                stopMusic(); // Stop menu music
                
                // Switch to game screen but keep it hidden initially
                showScreen('game-screen');
                
                // Hide the room image initially to prevent flash
                const imgElement = document.getElementById('room-image');
                imgElement.style.display = 'none';
                imgElement.style.opacity = '0';

                // Show intro text while video plays
                document.getElementById('location-desc').textContent = 'Entering the mansion together...';

                // Play intro video first
                playVideo('images/videos/intro_video.mp4', async () => {
                    // After video ends, load the multiplayer game state
                    playRoomAmbient('entrance_hall');
                    
                    // Execute a "look" command to get initial state
                    await executeCommand('look');
                });
            } catch (error) {
                console.error('Error loading room game:', error);
                alert('Failed to load room game');
            }
        }

        async function leaveRoom() {
            if (!currentRoomCode) return;

            try {
                const response = await fetch(`${API_URL}/leave_room`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUserId
                    },
                    body: JSON.stringify({ room_code: currentRoomCode })
                });
                const data = await response.json();

                if (data.success) {
                    if (isRoomOwner) {
                        alert('Room closed and game saved!');
                    }
                    currentRoomCode = null;
                    isRoomOwner = false;
                    showScreen('welcome-screen');
                }
            } catch (error) {
                console.error('Error leaving room:', error);
            }
        }

        // Utility functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }
    </script>
</body>
</html>

